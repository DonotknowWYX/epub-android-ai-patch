name: EPUBium Build with Volume Key Mod

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  setup_android_sdk:
    name: Setup Android SDK
    runs-on: ubuntu-22.04
    outputs:
      android-sdk-path: ${{ steps.setup.outputs.android-home }}
    steps:
      - name: Checkout minimal code
        uses: actions/checkout@v4
        with:
          path: sdk-setup
          
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download Android Tools
        run: |
          TOOLS_VERSION="9477386"  # 兼容JDK 17的稳定版本
          wget https://dl.google.com/android/repository/commandlinetools-linux-${TOOLS_VERSION}_latest.zip -O tools.zip
          unzip tools.zip -d cmdline-tools
          mv cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest
          rm tools.zip
        env:
          ANDROID_HOME: /usr/local/lib/android/sdk
        
      # ===== 关键修复：接受所有SDK许可证 =====
      - name: Accept all Android licenses
        run: |
          # 创建许可证目录
          mkdir -p $ANDROID_HOME/licenses
          # 接受所有许可证（自动生成所需的许可证文件）
          echo "d56f5187479451a728f00fdead2e6e72" > $ANDROID_HOME/licenses/android-sdk-license
          echo "84831b9409646a918e30573bab4c9c72" > $ANDROID_HOME/licenses/android-sdk-preview-license
          echo "8933bad161af4178b1185d1f37dbf86a" >> $ANDROID_HOME/licenses/android-sdk-license
          
      - name: Install essential packages
        run: |
          # 安装必需的Android SDK组件
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-33" "build-tools;29.0.3"
          
      - name: Export SDK path
        run: echo "android-home=$ANDROID_HOME" >> $GITHUB_OUTPUT

  build_apk:
    name: Build APK
    needs: setup_android_sdk
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout full code
        uses: actions/checkout@v4
        
      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          
      - name: Configure SDK path
        run: |
          echo "sdk.dir=${{ needs.setup_android_sdk.outputs.android-sdk-path }}" > local.properties
          
      - name: Fix gradlew permissions
        run: chmod +x gradlew
          
      - name: Build APK
        run: ./gradlew assembleDebug --stacktrace
        
      - name: Prepare artifact
        run: |
          mkdir apk-artifact
          cp app/build/outputs/apk/debug/*.apk apk-artifact/
        
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: epubium-volume-mod-apk
          path: apk-artifact/
          
      # 调试信息
      - name: Verify licenses
        if: ${{ always() }}
        run: |
          echo "====== Installed licenses ======"
          ls -l ${{ needs.setup_android_sdk.outputs.android-sdk-path }}/licenses
          echo "====== SDK Components ======"
          ${{ needs.setup_android_sdk.outputs.android-sdk-path }}/cmdline-tools/latest/bin/sdkmanager --list_installed
